<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê¸°ë„ ì§€ë„ - ì˜¤ì„ ì§€</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
  <style>
    /* ì „ì²´ í™”ë©´ ì„¤ì • */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
    }

    /* ì˜¤ì„ ì§€ ì´ë¯¸ì§€ë¥¼ ë°°ê²½ìœ¼ë¡œ ì„¤ì •í•˜ê³  í™”ë©´ì— ê½‰ ì±„ì›€ */
    #score-sheet {
      width: 100vw; /* ë·°í¬íŠ¸ ë„ˆë¹„ */
      height: 100vh; /* ë·°í¬íŠ¸ ë†’ì´ */
      background-image: url('image_7475ff.png'); /* **ì—…ë¡œë“œí•˜ì‹  ì´ë¯¸ì§€ íŒŒì¼ëª…ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”** */
      background-size: cover; /* ì´ë¯¸ì§€ë¥¼ ê½‰ ì±„ìš°ë„ë¡ ì„¤ì • */
      background-repeat: no-repeat;
      background-position: center;
      position: relative; /* ë§ˆì»¤ì˜ ì ˆëŒ€ ìœ„ì¹˜ ê¸°ì¤€ì  */
    }

    /* ë§ˆì»¤ ìŠ¤íƒ€ì¼ */
    .icon-marker {
      position: absolute; /* ì ˆëŒ€ ìœ„ì¹˜ ì§€ì • */
      font-size: 30px; /* í•˜íŠ¸ í¬ê¸° ì¡°ì • */
      line-height: 1;
      text-align: center;
      /* ë§ˆì»¤ê°€ ì¤‘ì•™ì— ì˜¤ë„ë¡ ì¡°ì • */
      transform: translate(-50%, -50%); 
    }

    /* í•˜íŠ¸ ë°•ë™ ì• ë‹ˆë©”ì´ì…˜ */
    .pulse-heart {
      animation: beat 1.2s infinite;
      transform-origin: center;
    }

    @keyframes beat {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.4); }
    }
  </style>
</head>
<body>
  <div id="score-sheet"></div>

  <script type="module">
    // Firebase ë° FirestoreëŠ” ë™ì¼í•˜ê²Œ ìœ ì§€
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { firebaseConfig } from "./config.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // ì˜¤ì„ ì§€ ì˜ì—­ DOM ìš”ì†Œ
    const scoreSheet = document.getElementById('score-sheet');

    function getRandomHeart() {
      const hearts = ['ğŸ’š', 'ğŸ’›', 'â¤ï¸'];
      return hearts[Math.floor(Math.random() * hearts.length)];
    }

    // ì˜¤ì„ ì§€ ë¼ì¸ì— ë§ˆì»¤ë¥¼ ë°°ì¹˜í•˜ëŠ” í•¨ìˆ˜
    // x, yëŠ” **score-sheet** ì˜ì—­ ë‚´ì—ì„œì˜ ë°±ë¶„ìœ¨ ì¢Œí‘œ(0~100)ì…ë‹ˆë‹¤.
    // **ì´ ì¢Œí‘œë¥¼ ìˆ˜ì •í•˜ì—¬ í•˜íŠ¸ ìœ„ì¹˜ë¥¼ ì˜¤ì„ ì§€ ë¼ì¸ì— ë§ì¶”ì„¸ìš”.**
    function addMarker(xPercent, yPercent) {
      const heart = getRandomHeart();
      const marker = document.createElement('div');
      marker.className = 'icon-marker pulse-heart';
      marker.innerHTML = heart;
      
      // ë°±ë¶„ìœ¨ ìœ„ì¹˜ë¡œ ì„¤ì •
      marker.style.left = `${xPercent}%`;
      marker.style.top = `${yPercent}%`; 

      scoreSheet.appendChild(marker);
    }

    // Firestore ë¦¬ìŠ¤ë„ˆ
    onSnapshot(collection(db, "outreach_prayers"), (snapshot) => {
      // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
      document.querySelectorAll('.icon-marker').forEach(marker => marker.remove());

      const now = new Date();
      const hourAgo = new Date(now.getTime() - 60 * 60 * 1000);

      let markerCount = 0;
      
      snapshot.forEach(doc => {
        const data = doc.data();
        const ts = data.timestamp?.toDate?.();

        if (ts && ts > hourAgo) {
          // ë¬¸ì„œì˜ ê³ ìœ  ID ë˜ëŠ” ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ìœ„ì¹˜ë¥¼ ê²°ì •
          const docId = doc.id;
          
          // ì„ì‹œ: ë¬¸ì„œ IDì˜ í•´ì‹œ ê°’ì´ë‚˜ ì¸ë±ìŠ¤ë¥¼ ì´ìš©í•´ ì˜¤ì„ ì§€ ë¼ì¸ì— ë°°ì¹˜í•  x, y ì¢Œí‘œë¥¼ ê³„ì‚°
          // ì´ ë¶€ë¶„ì€ ë°ì´í„°ë¥¼ ì˜¤ì„ ì§€ ìœ„ì— ì‹œê°ì ìœ¼ë¡œ ë§¤í•‘í•˜ëŠ” **í•µì‹¬ ë¡œì§**ì…ë‹ˆë‹¤.
          // í˜„ì¬ëŠ” ë¬¸ì„œ ì¸ë±ìŠ¤(markerCount)ë¥¼ ì‚¬ìš©í•˜ì—¬ ëŒ€ëµì ì¸ ìœ„ì¹˜ë¥¼ ì¡ì•˜ìŠµë‹ˆë‹¤.
          
          // X ì¢Œí‘œ: 10% (ì™¼ìª½) ~ 90% (ì˜¤ë¥¸ìª½) ì‚¬ì´
          const x = 10 + (markerCount % 10) * 8; 

          // Y ì¢Œí‘œ: ì˜¤ì„ ì§€ ê°„ê²©ì— ë§ì¶° 15%, 35%, 55%, 75%, 95% ê·¼ì²˜ì— ë°°ì¹˜
          // ì˜¤ì„ ì§€ ì¤„ ìˆ˜(5ê°œ)ì— ë”°ë¼ Y ìœ„ì¹˜ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.
          const staveIndex = Math.floor(markerCount / 10) % 5;
          const baseY = 15 + staveIndex * 20; // 15, 35, 55, 75, 95
          
          // ì˜¤ì„ ì§€ í•œ ì¤„ ë‚´ì—ì„œ ë†’ì€ ìŒìë¦¬í‘œ ì¤„(5ì¤„) ìœ„ì— í•˜íŠ¸ë¥¼ ëœë¤í•˜ê²Œ ë°°ì¹˜í•˜ê¸° ìœ„í•œ ì¡°ì •
          // (0.1 ~ 5.9 ì‚¬ì´ì˜ ì„ì˜ì˜ ê°’ìœ¼ë¡œ ì¤„ ìœ„ì¹˜ë¥¼ ì‹œë®¬ë ˆì´ì…˜)
          const lineOffset = (markerCount % 5) * 4; // ì„ì˜ë¡œ 5ê°œ ì¤„ì— ë„ì›Œì„œ ë°°ì¹˜

          const y = baseY + lineOffset;
          
          // ì¢Œí‘œ ë²”ìœ„ ì¡°ì • (Yê°€ ë„ˆë¬´ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡)
          const finalY = Math.min(Math.max(y, 10), 95); 

          addMarker(x, finalY);
          markerCount++;
        }
      });
    });
  </script>
  
  </body>
</html>
